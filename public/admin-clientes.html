<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de administraci√≥n - Clientes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #020617;
      --card-soft: #0b1220;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.15);
      --accent-strong: #0ea5e9;
      --danger: #f97373;
      --danger-soft: rgba(248,113,113,0.12);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #9ca3af;
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .title-group h1 {
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    .title-group p {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 0.75rem;
    }

    .badge span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-strong);
    }

    .layout {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(2,6,23,0.98));
      border-radius: var(--radius);
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -80%;
      background: radial-gradient(circle at top, rgba(56,189,248,0.06), transparent 60%);
      opacity: 0.65;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .card-header h2 {
      font-size: 1.05rem;
    }

    .pill {
      font-size: 0.7rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
    }

    .subtext {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* FORMULARIO */
    form label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 3px;
    }

    form input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      margin-bottom: 8px;
    }

    form input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
      background: rgba(15,23,42,1);
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row > div {
      flex: 1;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      font-size: 0.84rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-strong), #22c1c3);
      color: #0b1120;
      font-weight: 600;
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.4);
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .status {
      margin-top: 10px;
      font-size: 0.8rem;
      min-height: 18px;
    }

    .status.ok {
      color: #4ade80;
    }

    .status.error {
      color: var(--danger);
    }

    /* LISTADO */
    .list-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      flex: 1;
    }

    .search-box span {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .search-box input {
      flex: 1;  
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 0.8rem;
      padding: 0;
      margin-bottom: 0;
    }

    .count-chip {
      font-size: 0.78rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.35);
    }

    thead {
      background: linear-gradient(135deg, #020617, #0b1120);
    }

    th, td {
      padding: 7px 10px;
      text-align: left;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      font-size: 0.78rem;
      border-bottom: 1px solid rgba(148,163,184,0.25);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.8);
    }

    tbody tr:hover {
      background: rgba(30,64,175,0.4);
    }

    .row-muted {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .action-buttons {
      display: inline-flex;
      gap: 4px;
    }

    .btn-table {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 0.73rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-edit {
      background: rgba(56,189,248,0.12);
      color: var(--accent-strong);
      border: 1px solid rgba(56,189,248,0.45);
    }

    .btn-delete {
      background: var(--danger-soft);
      color: var(--danger);
      border: 1px solid rgba(248,113,113,0.5);
    }

    .empty-state {
      text-align: center;
      padding: 20px 10px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-group">
      <h1>RetroGamer ¬∑ Clientes</h1>
      <p>Gesti√≥n de clientes para el panel de administraci√≥n de tu tienda en l√≠nea.</p>
    </div>
  </header>

  <div class="layout">
    <!-- CARD FORMULARIO -->
    <section class="card">
      <div class="card-header">
        <h2 id="formTitulo">Nuevo cliente</h2>
        <span class="pill" id="modoEtiqueta">Modo creaci√≥n</span>
      </div>
      <p class="subtext">
        Registra o edita clientes.
      </p>

      <form id="formCliente" autocomplete="off">
        <label for="telefono">Tel√©fono (10 d√≠gitos)</label>
        <input type="text" id="telefono" maxlength="10" placeholder="Ej. 5512345678" />

        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" placeholder="Ej. Brandon Flores" />

        <label for="correo">Correo electr√≥nico</label>
        <input type="email" id="correo" placeholder="correo@ejemplo.com" />

        <div class="field-row">
          <div>
            <label for="password">Contrase√±a</label>
            <input type="password" id="password" placeholder="M√≠nimo 8 caracteres" />
          </div>
          <div>
            <label for="password2">Confirmar contrase√±a</label>
            <input type="password" id="password2" placeholder="Repite la contrase√±a" />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span class="btn-icon">üíæ</span>
            <span id="btnGuardarTexto">Guardar cliente</span>
          </button>
          <button type="button" class="btn btn-secondary" id="btnCancelar">
            <span class="btn-icon">‚Ü©</span>
            Cancelar
          </button>
        </div>
      </form>

      <div id="mensaje" class="status"></div>
    </section>

    <!-- CARD LISTADO -->
    <section class="card">
      <div class="card-header">
        <h2>Listado de clientes</h2>
      </div>

      <div class="list-header">
        <div class="search-box">
          <span>üîç</span>
          <input type="text" id="buscador" placeholder="Buscar por tel√©fono, nombre o correo..." />
        </div>
        <div class="count-chip">
          Total: <span id="totalClientes">0</span>
        </div>
      </div>

      <table>
        <thead>
        <tr>
          <th>Tel√©fono</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Registrado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="tbodyClientes">
        <!-- filas din√°micas -->
        </tbody>
      </table>

      <div id="estadoTabla" class="empty-state" style="display:none;">
        No se encontraron clientes. Agrega uno nuevo o ajusta el filtro de b√∫squeda.
      </div>
    </section>
  </div>
</div>

<script>
  const regexTelefono = /^[0-9]{10}$/;
  const regexCorreo  = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;

  const form = document.getElementById('formCliente');
  const mensaje = document.getElementById('mensaje');
  const tbody = document.getElementById('tbodyClientes');
  const estadoTabla = document.getElementById('estadoTabla');
  const buscador = document.getElementById('buscador');
  const totalClientesSpan = document.getElementById('totalClientes');
  const btnCancelar = document.getElementById('btnCancelar');
  const formTitulo = document.getElementById('formTitulo');
  const modoEtiqueta = document.getElementById('modoEtiqueta');
  const btnGuardarTexto = document.getElementById('btnGuardarTexto');
  const telInput = document.getElementById('telefono');

  let telefonoEnEdicion = null;      // null = creaci√≥n
  let clientesData = [];             // todos los clientes
  let clientesFiltrados = [];        // para b√∫squeda

  function mostrarMensaje(texto, tipo = 'ok') {
    mensaje.textContent = texto || '';
    mensaje.className = 'status ' + (tipo || '');
  }

  function limpiarFormulario() {
    form.reset();
    telefonoEnEdicion = null;
    telInput.disabled = false;
    formTitulo.textContent = 'Nuevo cliente';
    modoEtiqueta.textContent = 'Modo creaci√≥n';
    btnGuardarTexto.textContent = 'Guardar cliente';
    mostrarMensaje('');
  }

  function formatearFecha(fechaIso) {
    if (!fechaIso) return '-';
    const fecha = new Date(fechaIso);
    if (isNaN(fecha.getTime())) return fechaIso;
    return fecha.toLocaleString('es-MX', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function pintarTabla() {
    tbody.innerHTML = '';
    const lista = clientesFiltrados.length ? clientesFiltrados : clientesData;

    if (!lista.length) {
      estadoTabla.style.display = 'block';
      totalClientesSpan.textContent = '0';
      return;
    }

    estadoTabla.style.display = 'none';
    totalClientesSpan.textContent = lista.length.toString();

    lista.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-muted">${c.telefono}</td>
        <td>${c.nombre}</td>
        <td class="row-muted">${c.correo}</td>
        <td class="row-muted">${formatearFecha(c.creado_en)}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-table btn-edit" data-accion="editar" data-tel="${c.telefono}">
              ‚úè Editar
            </button>
            <button class="btn-table btn-delete" data-accion="eliminar" data-tel="${c.telefono}">
              üóë Eliminar
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function cargarClientes() {
    try {
      const res = await fetch('/api/clientes');
      if (!res.ok) {
        mostrarMensaje('No se pudieron obtener los clientes desde el servidor', 'error');
        return;
      }
      clientesData = await res.json();
      clientesFiltrados = [];
      pintarTabla();
    } catch (err) {
      console.error(err);
      mostrarMensaje('Error de comunicaci√≥n con el servidor', 'error');
    }
  }

  function validarFormulario() {
    const telefono = telInput.value.trim();
    const nombre   = document.getElementById('nombre').value.trim();
    const correo   = document.getElementById('correo').value.trim();
    const password = document.getElementById('password').value;
    const password2= document.getElementById('password2').value;

    const errores = [];

    if (!regexTelefono.test(telefono)) {
      errores.push('Tel√©fono inv√°lido (deben ser 10 d√≠gitos).');
    }
    if (!nombre) {
      errores.push('El nombre es obligatorio.');
    }
    if (!regexCorreo.test(correo)) {
      errores.push('Correo electr√≥nico inv√°lido.');
    }

    const esCreacion = telefonoEnEdicion === null;

    if (esCreacion || password || password2) {
      if (password.length < 8) {
        errores.push('La contrase√±a debe tener al menos 8 caracteres.');
      }
      if (password !== password2) {
        errores.push('Las contrase√±as no coinciden.');
      }
    }

    return errores;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const errores = validarFormulario();
    if (errores.length) {
      mostrarMensaje(errores.join(' '), 'error');
      return;
    }

    const telefono = telInput.value.trim();
    const nombre   = document.getElementById('nombre').value.trim();
    const correo   = document.getElementById('correo').value.trim();
    const password = document.getElementById('password').value;

    const payload = { nombre, correo };
    let url = '/api/clientes';
    let method = 'POST';

    if (telefonoEnEdicion === null) {
      payload.telefono = telefono;
      payload.password = password;
    } else {
      url += '/' + encodeURIComponent(telefonoEnEdicion);
      method = 'PUT';
      if (password) {
        payload.password = password;
      }
    }

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        const texto = data.errores ? data.errores.join(' ') : (data.mensaje || 'Error en la operaci√≥n.');
        mostrarMensaje(texto, 'error');
        return;
      }

      mostrarMensaje(data.mensaje || 'Operaci√≥n realizada correctamente', 'ok');
      await cargarClientes();
      limpiarFormulario();
    } catch (err) {
      console.error(err);
      mostrarMensaje('Error de comunicaci√≥n con el servidor', 'error');
    }
  });

  tbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-accion]');
    if (!btn) return;

    const accion = btn.dataset.accion;
    const tel = btn.dataset.tel;

    if (accion === 'editar') {
      try {
        const res = await fetch('/api/clientes/' + encodeURIComponent(tel));
        if (!res.ok) {
          mostrarMensaje('No se pudo obtener la informaci√≥n del cliente.', 'error');
          return;
        }
        const c = await res.json();
        telInput.value = c.telefono;
        telInput.disabled = true;
        document.getElementById('nombre').value = c.nombre;
        document.getElementById('correo').value = c.correo;
        document.getElementById('password').value = '';
        document.getElementById('password2').value = '';
        telefonoEnEdicion = c.telefono;
        formTitulo.textContent = 'Editar cliente';
        modoEtiqueta.textContent = 'Modo edici√≥n';
        btnGuardarTexto.textContent = 'Actualizar datos';
        mostrarMensaje('Editando cliente ' + c.telefono, 'ok');
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error de comunicaci√≥n con el servidor', 'error');
      }
    }

    if (accion === 'eliminar') {
      if (!confirm('¬øSeguro que deseas eliminar al cliente ' + tel + '?')) return;

      try {
        const res = await fetch('/api/clientes/' + encodeURIComponent(tel), {
          method: 'DELETE'
        });
        const data = await res.json();
        if (!res.ok) {
          mostrarMensaje(data.mensaje || 'No se pudo eliminar el cliente', 'error');
          return;
        }
        mostrarMensaje(data.mensaje, 'ok');
        await cargarClientes();
      } catch (err) {
        console.error(err);
        mostrarMensaje('Error de comunicaci√≥n con el servidor', 'error');
      }
    }
  });

  buscador.addEventListener('input', () => {
    const q = buscador.value.trim().toLowerCase();
    if (!q) {
      clientesFiltrados = [];
      pintarTabla();
      return;
    }
    clientesFiltrados = clientesData.filter(c =>
      c.telefono.toLowerCase().includes(q) ||
      (c.nombre || '').toLowerCase().includes(q) ||
      (c.correo || '').toLowerCase().includes(q)
    );
    pintarTabla();
  });

  btnCancelar.addEventListener('click', () => {
    limpiarFormulario();
  });

  // Cargar clientes existentes al iniciar
  cargarClientes();
</script>
</body>
</html>
